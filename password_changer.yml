## YAML Template.
---
begin:
  type: wizard_page
  desc: |
    The system is going to send you a One Time Pin (OTP) to verify that you are
    not a robot. Please enter this OTP in the following screen to start changing
    your password.
  post:
    - sql_values: >
        select u.email, p.first_name, p.last_name
        from user u join person p on u.person = p.id and u.id = '$uid'
    - write_session: email,first_name,last_name
    - clear_values

change:
  name: Change Password
  type: wizard
  width: 600
  height: 400
  steps:
    - begin
    - check_otp: { url: /user/check_otp, clear: true }
    - update_password

forgot:
  name: Forgot Password
  desc: Reset your password
  width: 900
  type: wizard
  steps:
    - enter_email
    - check_otp: { url: /user/check_otp, clear: true }
    - update_password
    - completion

enter_email:
  name: Start Changing Password
  desc: >
    Enter the email you used to register on the system below to start
    changing your password
  type: input_page
  inputs:
    - email: { valid: in(user) }
  post:
    - write_session: email

update_password:
  type: input_page
  width: 700
  name: Change Password
  desc: Please enter your new password and type it again to confirm it.
  inputs:
    - type: password_input
    - password
    - confirm_password
  navigate: [ update_password ]
  post:
    - read_session: email
    - sql_exec: >
        update user set password = password('$password'), attempts=0
        where email = '$email'
    - sql_values: select id uid from user where email = '$email'
    - write_session: uid
    - clear_values
    - close_dialog: Password has been changed successfully
  audit: $email
