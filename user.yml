## YAML Template.
---
include: [datatable,wizard]

activate:
  access: [admin]
  validate: none
  desc: Activate inactive user
  audit: $first_name $last_name ($key)
  post:
    - let: [email: $key]
    - collection.update: [user, $email, active: 1]
    - collection.values: [user, $email, first_name, last_name]
    - emailer.send: { type: activate_email }
    - refresh: "#page"

activate_email:
  from: $support_email
  to: $first_name $last_name <$email>
  subject: Your account has been activated
  message: >
    Dear <b>$first_name $last_name</b> <br><br>
    The administrator would like to inform you that your account has been activated for $program_name.<br><br>
    Regards,<br><br>
    <b>Customer Operations</b>

check_otp:
  type: input_page
  name: One Time Pin
  desc: >
    Please enter the OTP(One Time Pin) that you received on your email or cellphone.
    It is possible that the OTP email was sent to the Junk folder on your mail.
    <br><br>
    Note: If you navigated backwards to change something, you will be sent another OTP.
    Please make sure you enter this OTP instead of the first one.
  inputs:
    - otp
  values:
    - sql_values: select lpad(floor(rand()*9999),4,'0') server_otp, now() time_of_otp
    - write_session: server_otp,time_of_otp
    - read_session: email,first_name,last_name,cellphone
    - if $sms_otp:
        send_sms:
          message: Your OTP for $program_name is $server_otp
    - if $email_otp:
        emailer.send: { type: otp_email }
    - clear_values

otp_email:
  subject: One Time Password
  from: $support_email
  to: $first_name $last_name <$email>
  message: >
    Good day<br><br>
    You are currently trying to register on $program_name or change your email address.
    If you have not requested this, please inform the System Adminstrator.<br><br>
    Your One Time Password is : <b>$server_otp</b>. <br><br>
    Regards<br>
    Customer Operations

complete_registration:
  type: info_page
  lines:
    - >
      Thank you. You have been provisionally registered.
      You will have limited access to the system
      until your registration has been approved. <br>
      Please check your email for registration status.
  actions:
    - login: { action: dialog }

confirm_registration:
  type: input_page
  desc: |
    Below is a list of all the information you have entered to register on the system.
    If you are happy with everything, please accept the terms and conditions to
    complete the registration process.
  inputs:
    - type: filled_text
    - title
    - first_name
    - last_name
    - cellphone
    - email
    - password: { value: "**************" }
    - agree_terms: { template: question_input, type: checkbox}
  values:
    - read_session: title,first_name,last_name,cellphone,email
  validate: agree_terms
  post:
    - read_session: title,first_name,last_name,cellphone,email,password,registrant_partner
    - collection.insert: [user, $email, password: /password('$password'), active: 1, attempts: 0, title, first_name,last_name,cellphone,partner: $registrant_partner]
    - let: { registrant_name: $first_name $last_name, registrant_email: $email }
    - clear_values: [first_name, last_name, email]
    - foreach:
        - collection.data: [user, [partner: $registrar, role: $registrar_role],first_name, last_name, email: identifier]
        - if $email_new_registration:
            emailer.send: { type: new_registration_email }
        - clear_values: [first_name, last_name, email]
    - clear_values
    - clear_session: title,first_name,last_name,cellphone,password
  audit: $title $first_name $last_name $cellphone $email

new_registration_email:
  subject: New Registration on $program_name
  from: $registrant_name<$registrant_email>
  to: $first_name $last_name<$email>
  message: New user registration on $program_name from $registrant_name

create:
  type: labelled_input_page
  access: [admin]
  audit: >
    Title: $title, First Name:$first_name, Last Name:$last_name, Cellphone:$cellphone, E-Mail:$email, Role:$role
  width: 500
  name: Add User
  desc:  Add a new user
  inputs:
    - title: {type: dropdown}
    - first_name
    - last_name
    - cellphone
    - email:  { valid: [not_in_use] }
    - type: password_input
    - password
    - confirm_password
    - role: { type: dropdown }
  actions:
    - create

deactivate:
  access: [admin]
  validate: none
  desc: Deactivate this user
  audit: $first_name $last_name ($key)
  post:
    - let: [email: $key]
    - collection.update: [user, $email, active: 0]
    - collection.values: [user, $email, first_name, last_name]
    - emailer.send: { type: deactivate_email }
    - refresh: "#page"

dactivate_email:
  from: $support_email
  to: $first_name $last_name <$email>
  subject: Your account has been deactivated
  message: >
    Dear <b>$first_name $last_name</b> <br><br>
    The administrator would like to inform you that your account has been deactivated on $program_name.<br><br>
    Regards,<br><br>
    <b>Customer Operations</b>

delete:
  type: deactivate

edit:
  access: [admin]
  action: dialog
  fill: black
  url: /user/modify

enter_credentials:
  name: User Credentials
  type: input_page
  desc: Fill in user information used to uniquely identify the user on the system
  inputs:
    - title: {type: dropdown_collection}
    - first_name
    - last_name
    - cellphone
    - email: { valid: [not_registered] }
    - type: password_input
    - password
    - confirm_password
  post:
    - write_session: [title,first_name,last_name,cellphone,email,password]

history:
  access: [admin]
  type: datatable
  sort: when
  sort_order: desc
  flags:
    - show_titles
  fields:
    - when : { width: 14%, name: Time }
    - what: { width: 30%, name: Action }
    - detail: { width: 55% }
  sql: select create_time, action, detail from audit_trail where user = '$key'



is_active:
  valid: collection.exists(user,identifier,$value,active,1)
  error: |
    Account $value has been deactivated.
    Please ask the administrator to reactivate your account


is_registered:
  valid: collection.exists(user,$value)
  error: >
    There is no such email '$value' registered on the system.<br>
    Click on <b>Register</b> if you would like to register to use the system.

is_unlocked:
  max_attempts: 5
  valid: collection.exists(user,identifier,$value,attempts,/<$max_attempts)
  error: |
    Account $value locked because of too many incorrect attempts.
    Please ask the administrator to unlock your account.

list:
  access: [admin]
  type: datatable
  name: Users
  sort: create_time
  sort_order: desc
  page_size: 15
  flags:
    - filter
    - show_header
    - show_titles
  report_title: User Report
  row_actions:
    - activate
    - deactivate
    - edit: { action: dialog }
  footer_actions:
    - print
    - export
  fields:
    - email: { width: 20%, key: true }
    - first_name: { width: 13% }
    - last_name: { width: 13% }
    - cellphone: { width: 12% }
    - roles: { width: 9% }
    - status: { width: 8% }
    - style
    - actions
  expand:
    pages:
      - /user/history
  values:
    - collection.values: [session, $sid, partner]
    - collection.data:
        - user
        - partner: $partner
        - email: identifier
        - first_name
        - last_name
        - cellphone
        - roles: role.name
        - status: /if(active,'active','inactive')
        - style: /if(active,'active','inactive')
        - actions: /if(active,'expand,slide,edit,deactivate','expand,slide,edit,activate')
        - active

list_all:
  name: System Users
  access: [admin]
  type: list
  fields:
    - organisation: { push: email }
  values:
    - _reset
    - collection.scroll:
        - user
        - []
        - partner: partner.name
        - email: identifier
        - first_name asc
        - last_name
        - cellphone
        - roles: role.name
        - status: /if(active,'active','inactive')
        - style: /if(active,'active','inactive')
        - actions: /if(active,'expand,slide,edit,deactivate','expand,slide,edit,activate')
        - active


login:
  access: public
  type: input_page
  position: { my: 'top', at: 'top+150' }
  desc: Fill in your credentials below and click Login to logon
  enter: "#login"
  inputs:
    - email: { valid: login_email }
    - password: { valid: login_password }
  actions:
    - login
    - forgot_password: { action: dialog }
  post:
    - read_config: start_page
    - collection.values: [user, $email, partner, first_name, last_name, cellphone, start_page, start_url: "/ifnull(start_page,'$start_page')" ]
    - collection.listing: [user, $email, roles: role ]
    - collection.update: [user, $email, attempts: 0]
    - read_server: [HTTP_USER_AGENT,REMOTE_ADDR,REMOTE_HOST,REQUEST_URI]
    - collection.insert: [session, /sha1(last_insert_id()), user: $email, partner, start_time: /sysdate(6), HTTP_USER_AGENT, REMOTE_ADDR,REQUEST_URI]
    - write_session: [sid: $new_session_id, roles]
    - close_dialog
    - redirect: $start_url
  audit: $email

login_email:
  valid: [is_registered, is_active, is_unlocked]

login_password:
  valid:
    - depends(email, validated)
    - collection.exists(user,identifier,$email,password,/=password('$value'))
  error:
    - collection.update: [user, identifier: $email, attempts: /value+1]
    - collection.insert: [audit_trail, "", user: $email, action: Failed Login attempt]
    - error: [password, Invalid user name or password for $email ]

logout:
  read: action
  audit:
    post:
      - collection.insert: [session, $sid, end_time: /sysdate(6)]
      - this.logoff
      - redirect: "/"

modify:
  name: Change User Details
  type: input_page
  desc: Change user details
  access: [admin]
  width: 600
  inputs:
    - title: {type: dropdown}
    - first_name
    - last_name
    - cellphone
    - email: { valid: [not_registered] }
    - role:
        name: Assigned Role
        type: dropdown
        valid: provided
  values:
    - sql_values: |
        select p.title,p.first_name,p.last_name,u.cellphone,u.email,group_concat(r.name) role
        from user u left join person p on p.id = u.person
          left join role r on find_in_set(r.code,u.roles)
        where u.id = '$key'
        group by u.id
  actions:
    - modify: { name: Update User Details }
  validate: delta
  post:
    - sql_update: [user, id: $key, delta]
    - sql_update: [person, {id: /(select person from user where id = '$key')}, delta]
    - clear_values
    - close_dialog: User details updated
    - refresh: "#main table"
  audit: $email $delta

not_in_use:
  valid: not_registered
  error: Email address $value already in use

not_registered:
  valid: not(is_registered($1))
  error: |
    User $value is already registered on the system. If you have forgotten the
    password, use <i>Login/Forgot Password</i> feature to reset your password.

otp:
  name: OTP
  desc: One Time Pin
  valid: >
    sql(select 1 from dual where timestampdiff(minute, '$time_of_otp', now()) < 30 and '$otp'='$server_otp')

profile:
  type: input_page
  access: [reg]
  name: View Own Profile
  desc: These are your details on the system. You can make changes here to update them.
  width: 600
  inputs:
    - title: {type: dropdown_collection}
    - first_name
    - last_name
    - cellphone
    - email: { valid: [not_in_use]}
    - role: { attr: disabled }
  values:
    - collection.values: [session, identifier: $sid, user.title, user.first_name, user.last_name, user.cellphone, email: user, role: user.roles]
    - clear_values: [password,role,attempts]
  actions:
    - profile_update: { validate: delta }

profile_update:
  name: Update Profile
  audit: $title $first_name $last_name $cellphone $email
  post:
    - collection.update: [user, [identifier: $email], delta]
    - close_dialog: Successfully updated


register:
  access: public
  position: { my: 'top', at: 'top+50' }
  type: wizard
  name: Register User
  desc: Register as a new user of the system
  steps:
    - enter_credentials
    - check_otp: { clear: true }
    - confirm_registration: { clear: true}
    - complete_registration: { prev: false}
