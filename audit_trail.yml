base:
  type: datatable
  sort: when
  sort_order: desc
  page_size: 15
  flags:
    - filter
    - show_header
    - show_titles
  report_title: User Audit Trail
  actions:
    - print
    - export
  fields:
    - when: { width: 12%,name: Time }
    - first_name: { width: 10% }
    - last_name: { width: 16% }
    - email: { width: 18% }
    - what: { width: 18%, name: Action }
    - detail: { width: 35% }


user:
  type: base
  name: My Audit Trail
  access: [reg]
  sql: |
    select t.create_time, p.first_name, p.last_name,u.email, t.action, t.detail
      from audit_trail t join user u on t.user = u.id and u.id = '$uid'
      left join person p on u.person = p.id

partner:
  name: Partner Audit Trail
  type: base
  access: [admin]
  sql: |
    select t.create_time, p.first_name, p.last_name,u.email, t.action, t.detail
      from audit_trail t join user u on t.user = u.id
      and (u.id in (select id from user where partner = u.partner)
        or u.partner = t.partner)
      left join person p on u.person = p.id

system:
  name: System Audit Trail
  type: base
  access: [developer,admin]
  fields:
    - organisation: { push: first_name }
  sql: |
    select t.create_time, c.name, p.first_name, p.last_name,u.email, t.action, t.detail
      from audit_trail t join user u on t.user = u.id
      left join partner c on c.id = t.partner or c.id = u.partner
      left join person p on u.person = p.id
